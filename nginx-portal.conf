server {
    listen 80;
    server_name localhost;

    # Set the root for the entire server block. This is where your files are.
    root /usr/share/nginx/html;

    # This location handles the root URL, redirecting to your app's entry point.
    location = / {
        return 301 /portal/stories/;
    }

    # This is the main location block for your entire application.
    # It will match any URL that starts with /portal/
    location /portal/ {
        # The 'rewrite' directive is the key to this solution.
        # It takes any request that comes in (e.g., /portal/mastercode/foo.css)
        # and rewrites the URI to remove the /portal prefix (e.g., /mastercode/foo.css).
        # The 'break' flag tells Nginx to stop processing rewrites and continue
        # processing within this same location block using the new URI.
        rewrite ^/portal/(.*)$ /$1 break;

        # 'try_files' now works on the rewritten URI.
        # 1. It first tries to find a file matching the rewritten URI (e.g., /mastercode/foo.css).
        #    This will correctly find and serve your CSS, JS, and image assets.
        # 2. If it doesn't find a file (e.g., for an SPA route like /stories/), it falls back
        #    to serving the main /index.html file from the root. This allows your
        #    client-side router to handle the page navigation.
        try_files $uri $uri/ /index.html;
    }

    # Your health check endpoint remains unchanged.
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
